name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build binaries
        run: |
          # Linux AMD64
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o tncc-linux-amd64 tncc.go

          # Linux ARM64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o tncc-linux-arm64 tncc.go

          # macOS AMD64
          CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o tncc-darwin-amd64 tncc.go

          # macOS ARM64 (Apple Silicon)
          CGO_ENABLED=0 GOOS=darwin GOARCH=arm64 go build -o tncc-darwin-arm64 tncc.go

          # Windows AMD64
          CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o tncc-windows-amd64.exe tncc.go

      - name: Build Debian packages
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Build amd64 .deb
          mkdir -p tncc-deb-amd64/DEBIAN
          mkdir -p tncc-deb-amd64/usr/bin
          cp tncc-linux-amd64 tncc-deb-amd64/usr/bin/tncc
          chmod +x tncc-deb-amd64/usr/bin/tncc

          cat > tncc-deb-amd64/DEBIAN/control << EOF
          Package: tncc
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: amd64
          Maintainer: TNCC Maintainers
          Description: Terminal Network Connection Client for Juniper VPN
           A Go implementation of TNCC for interacting with Juniper VPN endpoints.
           Performs policy checks and retrieves authentication cookies.
          EOF

          dpkg-deb --build tncc-deb-amd64
          mv tncc-deb-amd64.deb tncc_${VERSION}_amd64.deb

          # Build arm64 .deb
          mkdir -p tncc-deb-arm64/DEBIAN
          mkdir -p tncc-deb-arm64/usr/bin
          cp tncc-linux-arm64 tncc-deb-arm64/usr/bin/tncc
          chmod +x tncc-deb-arm64/usr/bin/tncc

          cat > tncc-deb-arm64/DEBIAN/control << EOF
          Package: tncc
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: arm64
          Maintainer: TNCC Maintainers
          Description: Terminal Network Connection Client for Juniper VPN
           A Go implementation of TNCC for interacting with Juniper VPN endpoints.
           Performs policy checks and retrieves authentication cookies.
          EOF

          dpkg-deb --build tncc-deb-arm64
          mv tncc-deb-arm64.deb tncc_${VERSION}_arm64.deb

      - name: Build RPM packages
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Install rpm build tools
          sudo apt-get update
          sudo apt-get install -y rpm

          # Build x86_64 .rpm
          mkdir -p tncc-rpm-x86_64/usr/bin
          cp tncc-linux-amd64 tncc-rpm-x86_64/usr/bin/tncc
          chmod +x tncc-rpm-x86_64/usr/bin/tncc

          cat > tncc.spec << EOF
          Name: tncc
          Version: ${VERSION}
          Release: 1
          Summary: Terminal Network Connection Client for Juniper VPN
          License: MIT
          URL: https://github.com/username/tncc

          %description
          A Go implementation of TNCC for interacting with Juniper VPN endpoints.
          Performs policy checks and retrieves authentication cookies.

          %install
          mkdir -p %{buildroot}/usr/bin
          cp %{_sourcedir}/tncc %{buildroot}/usr/bin/tncc

          %files
          /usr/bin/tncc
          EOF

          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          cp tncc.spec ~/rpmbuild/SPECS/
          cp tncc-rpm-x86_64/usr/bin/tncc ~/rpmbuild/SOURCES/
          rpmbuild --target x86_64 -bb ~/rpmbuild/SPECS/tncc.spec
          cp ~/rpmbuild/RPMS/x86_64/tncc-${VERSION}-1.x86_64.rpm ./

          # Build aarch64 .rpm
          mkdir -p tncc-rpm-aarch64/usr/bin
          cp tncc-linux-arm64 tncc-rpm-aarch64/usr/bin/tncc
          chmod +x tncc-rpm-aarch64/usr/bin/tncc

          cp tncc-rpm-aarch64/usr/bin/tncc ~/rpmbuild/SOURCES/
          rpmbuild --target aarch64 -bb ~/rpmbuild/SPECS/tncc.spec
          cp ~/rpmbuild/RPMS/aarch64/tncc-${VERSION}-1.aarch64.rpm ./

      - name: Create self-extracting runners
        run: |
          # Function to create self-extracting script
          create_runner() {
            local binary=$1
            local output=$2
            local platform=$3

            cat > "${output}" << 'RUNNER_EOF'
          #!/bin/sh
          # Self-extracting runner for TNCC
          # Compatible with Android/Termux and standard Linux/macOS environments

          # Create temporary directory for extraction
          # Try mktemp first, fall back to manual creation for Android/Termux
          if command -v mktemp >/dev/null 2>&1; then
            TMPDIR=$(mktemp -d 2>/dev/null || mktemp -d -t tncc)
          else
            TMPDIR="${TMPDIR:-/data/local/tmp}/tncc.$$"
            mkdir -p "$TMPDIR" 2>/dev/null || TMPDIR="/tmp/tncc.$$"
            mkdir -p "$TMPDIR"
          fi

          # Cleanup function
          cleanup() {
            rm -rf "$TMPDIR"
          }
          trap cleanup EXIT INT TERM

          # Find the binary data marker
          # Use sed as it's more portable than awk on Android
          MARKER=$(sed -n '/^__BINARY_DATA__/=' "$0" | head -n 1)
          MARKER=$((MARKER + 1))

          # Extract binary to temp directory
          # Try base64 -d first (GNU/Linux), then base64 -D (macOS), then base64 without flags (Android)
          if tail -n +$MARKER "$0" | base64 -d > "$TMPDIR/tncc" 2>/dev/null; then
            :
          elif tail -n +$MARKER "$0" | base64 -D > "$TMPDIR/tncc" 2>/dev/null; then
            :
          else
            tail -n +$MARKER "$0" | base64 > "$TMPDIR/tncc"
          fi

          chmod +x "$TMPDIR/tncc"

          # Execute the binary with all passed arguments
          exec "$TMPDIR/tncc" "$@"

          __BINARY_DATA__
          RUNNER_EOF

            # Append base64-encoded binary
            base64 "$binary" >> "${output}"
            chmod +x "${output}"
          }

          # Create runners for each platform
          create_runner "tncc-linux-amd64" "tncc-runner-linux-amd64.sh" "linux-amd64"
          create_runner "tncc-linux-arm64" "tncc-runner-linux-arm64.sh" "linux-arm64"
          create_runner "tncc-darwin-amd64" "tncc-runner-darwin-amd64.sh" "darwin-amd64"
          create_runner "tncc-darwin-arm64" "tncc-runner-darwin-arm64.sh" "darwin-arm64"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            tncc-linux-amd64
            tncc-linux-arm64
            tncc-darwin-amd64
            tncc-darwin-arm64
            tncc-windows-amd64.exe
            tncc_*_amd64.deb
            tncc_*_arm64.deb
            tncc-*-1.x86_64.rpm
            tncc-*-1.aarch64.rpm
            tncc-runner-linux-amd64.sh
            tncc-runner-linux-arm64.sh
            tncc-runner-darwin-amd64.sh
            tncc-runner-darwin-arm64.sh
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
